generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  MENTOR
  MENTEE
  BOTH
  ADMIN
  SPONSOR
}

enum CircleStatus {
  DRAFT
  PROPOSED
  OPEN
  ACTIVE
  COMPLETED
}

enum AppStatus {
  PENDING
  WAITLIST
  ACCEPTED
  REJECTED
}

enum ChangeRequestStatus {
  PENDING
  APPLIED
  REJECTED
}

model User {
  id              String   @id @default(cuid())
  role            Role     @default(BOTH)
  name            String
  email           String   @unique
  bio             String?
  linkedinUrl     String?
  avatarUrl       String?
  reputationScore Int      @default(100)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // A user can create a circle (as a mentee proposing or a mentor leading)
  circlesCreated Circle[] @relation("CreatedCircles")

  // A user can be the official assigned mentor of a circle
  circlesMentoring Circle[] @relation("MentoringCircles")

  // Applications submitted by this user
  applications Application[]

  // Circle updates requested by this user
  changeRequestsProposed CircleChangeRequest[] @relation("ProposedCircleChanges")
}

model Circle {
  id          String       @id @default(cuid())
  creatorId   String
  mentorId    String?
  title       String
  description String       @db.Text
  maxCapacity Int
  durationWeeks Int      @default(4)
  status      CircleStatus @default(PROPOSED)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  creator      User          @relation("CreatedCircles", fields: [creatorId], references: [id])
  mentor       User?         @relation("MentoringCircles", fields: [mentorId], references: [id])
  applications Application[]
  sessions     Session[]
  changeRequests CircleChangeRequest[]
}

model Application {
  id              String    @id @default(cuid())
  circleId        String
  menteeId        String
  intentStatement String    @db.Text
  status          AppStatus @default(PENDING)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  circle Circle @relation(fields: [circleId], references: [id])
  mentee User   @relation(fields: [menteeId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  circleId  String
  startTime DateTime
  endTime   DateTime
  videoLink String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  circle Circle @relation(fields: [circleId], references: [id])
}

model CircleChangeRequest {
  id               String              @id @default(cuid())
  circleId         String
  proposedById     String
  newMaxCapacity   Int?
  newDurationWeeks Int?
  notes            String?             @db.Text
  status           ChangeRequestStatus @default(PENDING)
  creatorApproved  Boolean             @default(false)
  mentorApproved   Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  circle      Circle @relation(fields: [circleId], references: [id])
  proposedBy  User   @relation("ProposedCircleChanges", fields: [proposedById], references: [id])
}
